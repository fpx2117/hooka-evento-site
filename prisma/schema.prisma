// ========================================================
// Prisma Schema — Eventos con Entradas Generales y Mesas VIP
// DB: PostgreSQL
// ========================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================= Enums =========================

enum PaymentStatus {
  pending
  approved
  rejected
  in_process
  failed_preference
  cancelled
  refunded
  charged_back
}

enum PaymentMethod {
  mercadopago
  transferencia
  efectivo
}

enum DiscountType {
  percent // porcentaje (ej: 10 = 10%)
  amount  // monto fijo (ej: 500)
}

enum Gender {
  hombre
  mujer
}

enum TableLocation {
  piscina
  dj
  general
}

enum TicketType {
  general
  vip
}

enum PackageType {
  mesa
}

// ========================= Admin =========================

model Admin {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())

  @@index([username])
}

// ========================= Evento =========================

model Event {
  id            String           @id @default(cuid())
  code          String           @unique
  name          String
  date          DateTime
  isActive      Boolean          @default(true)

  ticketConfig  TicketConfig[]
  vipConfigs    VipTableConfig[]

  tickets       Ticket[]
  tableRes      TableReservation[]

  discountRules DiscountRule[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt
}

// ========================= Tickets =========================
// Un ticket representa una operación de acceso (puede cubrir N personas vía quantity).
// Para VIP, gender = null y puede vincularse a una TableReservation.

model Ticket {
  id                 String         @id @default(cuid())

  eventId            String
  event              Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)

  ticketType         TicketType
  gender             Gender?
  quantity           Int            @default(1)        // personas

  totalPrice         Decimal        @db.Decimal(10, 2)

  customerName       String
  customerEmail      String
  customerPhone      String
  customerDni        String

  paymentId          String?        @unique
  paymentStatus      PaymentStatus  @default(pending)
  paymentMethod      PaymentMethod  @default(mercadopago)

  qrCode             String?        @unique
  validationCode     String?        @unique
  validated          Boolean        @default(false)
  validatedAt        DateTime?

  purchaseDate       DateTime       @default(now())
  eventDate          DateTime?
  expiresAt          DateTime?

  // Trazabilidad de precio/stock aplicado
  ticketConfigId     String?
  ticketConfig       TicketConfig?  @relation(fields: [ticketConfigId], references: [id], onDelete: SetNull)

  // Relación con reserva VIP (si corresponde)
  tableReservationId String?
  tableReservation   TableReservation? @relation(fields: [tableReservationId], references: [id], onDelete: SetNull)

  // Ubicación (opcional, para reporting rápido; también se infiere desde la reserva)
  location           TableLocation?

  // Idempotencia de mail/entrega
  emailSentAt        DateTime?

  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @default(now()) @updatedAt

  @@index([eventId])
  @@index([customerEmail])
  @@index([paymentId])
  @@index([customerDni])
  @@index([paymentStatus, purchaseDate])
  @@index([ticketType, gender])
  @@index([emailSentAt])
  @@index([tableReservationId])
}

// ========================= Reservas de Mesa VIP =========================
// Representa la compra/reserva de MESAS (stock operativo en mesas).
// El cupo GLOBAL (personas) se descuenta al aprobar generando Ticket vip.

model TableReservation {
  id               String         @id @default(cuid())

  eventId          String
  event            Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)

  packageType      PackageType    @default(mesa)
  location         TableLocation

  tables           Int            @default(1)          // cantidad de mesas
  capacity         Int                                 // personas = tables * capacityPerTable
  guests           Int            @default(0)

  totalPrice       Decimal        @db.Decimal(10, 2)

  customerName     String
  customerEmail    String
  customerPhone    String
  customerDni      String
  reservationDate  DateTime

  paymentId        String?        @unique
  paymentStatus    PaymentStatus  @default(pending)
  paymentMethod    PaymentMethod  @default(mercadopago)

  qrCode           String?        @unique
  validationCode   String?        @unique
  validated        Boolean        @default(false)
  validatedAt      DateTime?

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @default(now()) @updatedAt
  expiresAt        DateTime?

  vipTableConfigId String?
  vipTableConfig   VipTableConfig? @relation(fields: [vipTableConfigId], references: [id], onDelete: SetNull)

  // Emails idempotentes
  emailSentAt      DateTime?

  // Relación inversa a tickets emitidos por aprobación
  tickets          Ticket[]

  @@index([eventId])
  @@index([customerEmail])
  @@index([paymentId])
  @@index([reservationDate])
  @@index([customerDni])
  @@index([paymentStatus, reservationDate])
  @@index([location, reservationDate])
  @@index([emailSentAt])
}

// ========================= Reglas de descuento =========================
// Por cantidad y tipo de ticket. Para VIP gender = null.

model DiscountRule {
  id         String        @id @default(cuid())

  eventId    String
  event      Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)

  ticketType TicketType
  gender     Gender?

  minQty     Int
  type       DiscountType
  value      Decimal       @db.Decimal(10, 2)
  isActive   Boolean       @default(true)
  priority   Int           @default(0)   // desempate

  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @default(now()) @updatedAt

  @@unique([eventId, ticketType, gender, minQty])
  @@index([eventId, ticketType, gender, isActive])
}

// ========================= Configuración de ENTRADAS =========================
// Filas típicas por evento:
// - (ticketType="general", gender=hombre)
// - (ticketType="general", gender=mujer)
// - (ticketType="vip",     gender=null)  -> precio por persona VIP (si aplica)
// - (ticketType="total",   gender=null)  -> cupo TOTAL (personas) del evento

model TicketConfig {
  id         String        @id @default(cuid())

  eventId    String
  event      Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)

  ticketType String        // se mantiene String para permitir "total"
  gender     Gender?

  price      Decimal       @db.Decimal(10, 2)
  stockLimit Int           @default(0)
  soldCount  Int           @default(0)

  tickets    Ticket[]

  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @default(now()) @updatedAt

  @@unique([eventId, ticketType, gender], name: "eventId_ticketType_gender")
  @@index([eventId, ticketType, gender])
  @@index([eventId])
  @@index([ticketType])
}

// ========================= Configuración MESAS VIP =========================
// Stock por ubicación (en MESAS) y capacidad por mesa.

model VipTableConfig {
  id               String        @id @default(cuid())

  eventId          String
  event            Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)

  location         TableLocation
  price            Decimal       @db.Decimal(10, 2)

  stockLimit       Int
  soldCount        Int           @default(0)
  capacityPerTable Int           @default(10)

  tableRes         TableReservation[]

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @default(now()) @updatedAt

  @@unique([eventId, location])
  @@index([eventId, location])
}
