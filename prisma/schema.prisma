// ========================================================
// Prisma Schema — Entradas Generales y VIP (por ubicación)
// DB: PostgreSQL
// ========================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================= Enums =========================

enum PaymentStatus {
  pending
  approved
  rejected
  in_process
  failed_preference
  cancelled
  refunded
  charged_back
}

enum PaymentMethod {
  mercadopago
  transferencia
  efectivo
}

enum DiscountType {
  percent // porcentaje (ej: 10 = 10%)
  amount  // monto fijo (ej: 500)
}

enum Gender {
  hombre
  mujer
}

enum TableLocation {
  piscina
  dj
  general
}

enum TicketType {
  general
  vip
}

// ========================= Admin =========================

model Admin {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())

  @@index([username])
}

// ========================= Evento =========================

model Event {
  id            String           @id @default(cuid())
  code          String           @unique
  name          String
  date          DateTime
  isActive      Boolean          @default(true)

  ticketConfig  TicketConfig[]
  vipConfigs    VipTableConfig[]

  tickets       Ticket[]
  discountRules DiscountRule[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ========================= Ticket (ÚNICA entidad de venta) =========================
// - GENERAL: quantity = personas, gender = hombre|mujer, vip* = null
// - VIP:     vipLocation + vipTables + capacityPerTable (quantity no se usa para stock)

model Ticket {
  id                 String         @id @default(cuid())

  eventId            String
  event              Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)

  ticketType         TicketType
  gender             Gender?                 // sólo en general
  quantity           Int            @default(1) // personas (sólo general)

  // VIP (por ubicación, en mesas)
  vipLocation        TableLocation?
  vipTables          Int?                      // mesas compradas (VIP)
  capacityPerTable   Int?                      // personas por mesa (VIP)

  totalPrice         Decimal        @db.Decimal(10, 2)

  customerName       String
  customerEmail      String
  customerPhone      String
  customerDni        String

  paymentId          String?        @unique
  paymentStatus      PaymentStatus  @default(pending)
  paymentMethod      PaymentMethod  @default(mercadopago)

  qrCode             String?        @unique
  validationCode     String?        @unique
  validated          Boolean        @default(false)
  validatedAt        DateTime?

  purchaseDate       DateTime       @default(now())
  eventDate          DateTime?
  expiresAt          DateTime?

  // Trazabilidad de precio/stock aplicado
  ticketConfigId     String?
  ticketConfig       TicketConfig?  @relation(fields: [ticketConfigId], references: [id], onDelete: SetNull)

  // Idempotencia de mail/entrega
  emailSentAt        DateTime?

  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  @@index([eventId])
  @@index([customerEmail])
  @@index([customerDni])
  @@index([paymentId])
  @@index([paymentStatus, purchaseDate])
  @@index([ticketType, gender])
  @@index([emailSentAt])
  @@index([vipLocation])
}

// ========================= Reglas de descuento =========================
// String para compatibilidad (valores esperados: "general" | "vip")

model DiscountRule {
  id         String        @id @default(cuid())

  eventId    String
  event      Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)

  ticketType String        // "general" | "vip"
  gender     Gender?       // en VIP es null

  minQty     Int
  type       DiscountType
  value      Decimal       @db.Decimal(10, 2)
  isActive   Boolean       @default(true)
  priority   Int           @default(0)

  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@unique([eventId, ticketType, gender, minQty])
  @@index([eventId, ticketType, gender, isActive])
}

// ========================= Configuración de ENTRADAS =========================
// Filas típicas por evento:
// - (ticketType="general", gender=hombre)
// - (ticketType="general", gender=mujer)
// - (ticketType="total",   gender=null)  -> cupo TOTAL (personas) del evento
// (Si querés precio por persona VIP —poco común— podés agregar fila "vip", gender=null)

model TicketConfig {
  id         String        @id @default(cuid())

  eventId    String
  event      Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)

  ticketType String        // "general" | "total" | (opcional "vip")
  gender     Gender?

  price      Decimal       @db.Decimal(10, 2)
  stockLimit Int           @default(0) // para "total" = cupo total (personas)
  soldCount  Int           @default(0)

  tickets    Ticket[]

  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@unique([eventId, ticketType, gender], name: "eventId_ticketType_gender")
  @@index([eventId, ticketType, gender])
  @@index([eventId])
  @@index([ticketType])
}

// ========================= Configuración MESAS VIP (por ubicación) =========================
// Stock y precio por ubicación (en MESAS) + capacidad por mesa.
// Se descuenta/incrementa en función de Tickets VIP aprobados/anulados.

model VipTableConfig {
  id               String        @id @default(cuid())

  eventId          String
  event            Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)

  location         TableLocation
  price            Decimal       @db.Decimal(10, 2)

  stockLimit       Int           // mesas totales disponibles en esta ubicación
  soldCount        Int           @default(0) // mesas vendidas (suma de vipTables aprobadas)
  capacityPerTable Int           @default(10)

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@unique([eventId, location])
  @@index([eventId, location])
}
