generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================
// ENUMS
// ===========================

enum PaymentStatus {
  pending
  approved
  rejected
  in_process
  failed_preference
  cancelled
  refunded
  charged_back
}

enum PaymentMethod {
  mercadopago
  transferencia
  efectivo
}

enum Gender {
  hombre
  mujer
}

enum TableLocation {
  piscina
  dj
  general
}

enum TicketType {
  general
  vip
}

enum DiscountType {
  percent
  amount
}

enum ArchiveReason {
  user_deleted
  admin_cancelled
  payment_timeout
  refunded
  charged_back
  other
}

enum VipTableStatus {
  available
  reserved
  sold
  blocked
}

// ===========================
// MODELOS
// ===========================

model Admin {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())

  @@index([username])
}

model Event {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  date      DateTime
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  totalLimitPersons Int @default(0)
  soldPersons       Int @default(0)
  remainingPersons  Int @default(0)

  tickets        Ticket[]
  ticketConfigs  TicketConfig[]
  vipConfigs     VipTableConfig[]
  vipLocations   VipLocation[]
  vipTables      VipTable[]
  ticketArchives TicketArchive[]
  discountRules  DiscountRule[]
}

model Ticket {
  id               String         @id @default(cuid())
  ticketType       TicketType
  quantity         Int            @default(1)
  totalPrice       Decimal        @db.Decimal(10, 2)
  customerName     String
  customerEmail    String
  customerPhone    String
  customerDni      String
  gender           Gender?
  paymentId        String?        @unique
  paymentStatus    PaymentStatus  @default(pending)
  paymentMethod    PaymentMethod  @default(mercadopago)
  qrCode           String?        @unique
  validationCode   String?        @unique
  validated        Boolean        @default(false)
  validatedAt      DateTime?
  purchaseDate     DateTime       @default(now())
  eventDate        DateTime?
  expiresAt        DateTime?
  emailSentAt      DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  capacityPerTable Int?
  vipLocation      TableLocation?
  vipTables        Int?
  tableNumber      Int?

  // Relaciones
  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  ticketConfigId String?
  ticketConfig   TicketConfig? @relation(fields: [ticketConfigId], references: [id], onDelete: SetNull)

  vipLocationId  String?
  vipLocationRef VipLocation? @relation("Ticket_VipLocation", fields: [vipLocationId], references: [id], onDelete: SetNull)

  vipTableId String?
  vipTable   VipTable? @relation(fields: [vipTableId], references: [id], onDelete: SetNull)

  vipTableConfigId String?
  vipTableConfig   VipTableConfig? @relation(fields: [vipTableConfigId], references: [id], onDelete: SetNull)

  archives TicketArchive[] @relation("Ticket_ArchivedFrom")

  @@index([eventId])
  @@index([paymentId])
  @@index([paymentStatus, purchaseDate])
  @@index([ticketType, gender])
  @@index([customerEmail])
  @@index([customerDni])
  @@index([emailSentAt])
  @@index([vipLocation])
  @@index([tableNumber])
}

model TicketArchive {
  id               String         @id @default(cuid())
  archivedFromId   String?
  eventId          String
  ticketType       TicketType
  gender           Gender?
  quantity         Int            @default(1)
  vipLocation      TableLocation?
  vipTables        Int?
  capacityPerTable Int?
  tableNumber      Int?
  totalPrice       Decimal        @db.Decimal(10, 2)
  customerName     String
  customerEmail    String
  customerPhone    String
  customerDni      String
  paymentId        String?
  paymentStatus    PaymentStatus  @default(pending)
  paymentMethod    PaymentMethod  @default(mercadopago)
  qrCode           String?
  validationCode   String?
  validated        Boolean        @default(false)
  validatedAt      DateTime?
  purchaseDate     DateTime       @default(now())
  eventDate        DateTime?
  expiresAt        DateTime?
  ticketConfigId   String?
  emailSentAt      DateTime?
  archivedAt       DateTime       @default(now())
  archivedBy       String?
  archiveReason    ArchiveReason  @default(other)
  archiveNotes     String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  archivedFrom     Ticket?         @relation("Ticket_ArchivedFrom", fields: [archivedFromId], references: [id], onDelete: SetNull)
  event            Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)
  ticketConfig     TicketConfig?   @relation(fields: [ticketConfigId], references: [id], onDelete: SetNull)
  vipLocationRef   VipLocation?    @relation("Archive_VipLocation", fields: [vipLocationId], references: [id], onDelete: SetNull)
  vipLocationId    String?
  vipTable         VipTable?       @relation(fields: [vipTableId], references: [id], onDelete: SetNull)
  vipTableId       String?
  vipTableConfig   VipTableConfig? @relation(fields: [vipTableConfigId], references: [id], onDelete: SetNull)
  vipTableConfigId String?

  @@index([eventId])
  @@index([customerEmail])
  @@index([customerDni])
  @@index([paymentId])
  @@index([paymentStatus, purchaseDate])
  @@index([ticketType, gender])
  @@index([emailSentAt])
  @@index([vipLocation])
  @@index([tableNumber])
}

model TicketConfig {
  id         String          @id @default(cuid())
  eventId    String
  event      Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)
  ticketType TicketType
  gender     Gender?
  price      Decimal         @db.Decimal(10, 2)
  stockLimit Int             @default(0)
  soldCount  Int             @default(0)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  tickets    Ticket[]
  archives   TicketArchive[]

  @@unique([eventId, ticketType, gender])
  @@index([eventId, ticketType, gender])
  @@index([eventId])
  @@index([ticketType])
}

model VipTableConfig {
  id      String @id @default(cuid())
  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  vipLocationId String
  vipLocation   VipLocation @relation(fields: [vipLocationId], references: [id], onDelete: Cascade)

  price            Decimal  @db.Decimal(10, 2)
  stockLimit       Int
  soldCount        Int      @default(0)
  capacityPerTable Int      @default(10)
  mapUrl           String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tickets   Ticket[]
  archives  TicketArchive[]
  vipTables VipTable[]

  @@unique([eventId, vipLocationId])
  @@index([eventId, vipLocationId])
}

model VipLocation {
  id        String           @id @default(cuid())
  eventId   String
  name      String
  isActive  Boolean          @default(true)
  order     Int              @default(0)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  event     Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  configs   VipTableConfig[]
  tables    VipTable[]
  tickets   Ticket[]         @relation("Ticket_VipLocation")
  archives  TicketArchive[]  @relation("Archive_VipLocation")
}

model VipTable {
  id               String         @id @default(cuid())
  eventId          String
  vipLocationId    String
  vipTableConfigId String?
  tableNumber      Int
  capacityPerTable Int            @default(10)
  price            Decimal        @default(0.00) @db.Decimal(10, 2)
  status           VipTableStatus @default(available)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  event          Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)
  vipLocation    VipLocation     @relation(fields: [vipLocationId], references: [id], onDelete: Cascade)
  vipTableConfig VipTableConfig? @relation(fields: [vipTableConfigId], references: [id], onDelete: SetNull)
  tickets        Ticket[]
  archives       TicketArchive[]
}

model DiscountRule {
  id         String       @id @default(cuid())
  eventId    String
  event      Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  ticketType TicketType
  gender     Gender?
  minQty     Int
  type       DiscountType
  value      Decimal      @db.Decimal(10, 2)
  isActive   Boolean      @default(true)
  priority   Int          @default(0)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  @@unique([eventId, ticketType, gender, minQty])
  @@index([eventId, ticketType, gender, isActive])
}
